<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Report Fault - WaterBill NG</title>
  <link rel="stylesheet" href="../assets/css/main.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    /* Ensure main content has enough padding at the bottom to prevent footer overlap */
    .content {
        min-height: calc(100vh - 100px);
        padding-bottom: 100px;
    }
    
    /* Adjust for mobile view */
    @media (max-width: 768px) {
        .content {
            padding-bottom: 150px; /* Extra space for mobile bottom nav */
        }
    }
    body{font-family:'Inter',Arial,sans-serif;margin:0;padding:0;background:linear-gradient(180deg,#11c0d4 0%,#08a9d4 40%,#04a0c9 60%,#039ed1 100%);min-height:100vh}
    .container{max-width:600px;margin:0 auto;padding:20px 16px 240px 16px}
    .card{background:#fff;border-radius:14px;box-shadow:0 8px 28px rgba(0,0,0,0.08);padding:18px 16px;margin-top:16px}
    .card h1{margin:0 0 6px 0;font-size:1.35rem;color:#1a2746}
    .card p.sub{margin:0 0 12px 0;color:#6b7280}
    .form-group{margin-bottom:14px}
    label{display:block;font-weight:700;color:#1a2746;margin-bottom:6px}
    select,input[type="text"],textarea{width:100%;padding:12px;border:1px solid #e0e7ff;border-radius:10px;font-size:14px}
    textarea{min-height:110px;resize:vertical}
    .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
    .btn{background:linear-gradient(135deg,#2e6fff,#1a2746);color:#fff;border:none;border-radius:10px;padding:12px 18px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#6b7280}
    .alert{padding:12px;border-radius:10px;margin-bottom:12px}
    .alert.success{background:#d4edda;border:1px solid #c3e6cb;color:#155724}
    .alert.error{background:#f8d7da;border:1px solid #f5c6cb;color:#721c24}
  </style>
</head>
<body>
  <div class="content">
  <div class="container">
    <div id="alert"></div>
    <div class="card">
      <h1>Report a Fault</h1>
      <p class="sub">Tell us what went wrong so we can fix it fast.</p>
      <form id="faultForm">
        <div class="form-group">
          <label for="category">Category</label>
          <select id="category" name="category" required>
            <option value="">Select</option>
            <option value="leak">Leak</option>
            <option value="no_water">No Water</option>
            <option value="low_pressure">Low Pressure</option>
            <option value="billing">Billing Issue</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label for="description">Description</label>
          <textarea id="description" name="description" placeholder="Describe the issue..." required></textarea>
        </div>
        <div class="form-group">
          <label for="photo">Photo (optional)</label>
          <input type="file" id="photo" name="photo" accept="image/*">
        </div>
        <div class="actions">
          <button type="button" class="btn secondary" id="resetBtn">Reset</button>
          <button type="submit" class="btn" id="submitBtn">Submit</button>
        </div>
      </form>
    </div>
  </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async function(){
      if (window.AuthGuard){ const s = await AuthGuard.requireUser(); if (!s) return; }
      else { await checkAuth(); }
      bindForm();
    });
    async function checkAuth(){
      try{
        const r = await fetch('../../api/auth/check-session.php',{credentials:'include'});
        const j = await r.json();
        const role = (j.role||'').toLowerCase();
        if (!j.authenticated || role==='admin') location.href='../auth/login.html';
      }catch{ location.href='../auth/login.html'; }
    }
    function showAlert(msg,type){
      const el=document.getElementById('alert');
      el.innerHTML = `<div class="alert ${type}">${msg}</div>`;
      setTimeout(()=>{ el.innerHTML=''; }, 5000);
    }
    function bindForm(){
      const form = document.getElementById('faultForm');
      const submitBtn = document.getElementById('submitBtn');
      const resetBtn = document.getElementById('resetBtn');
      resetBtn.addEventListener('click', ()=> form.reset());
      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        submitBtn.disabled=true; submitBtn.textContent='Submitting...';
        const fd = new FormData(form);
        try{
          const res = await fetch('../../api/user/report-fault.php',{method:'POST',body:fd,credentials:'include'});
          const data = await res.json();
          if (data.success){ showAlert(data.message||'Reported successfully','success'); if (window.notify) notify.success('Fault reported'); form.reset(); }
          else { showAlert(data.error||'Failed to report fault','error'); if (window.notify) notify.error(data.error||'Failed to report'); }
        }catch(err){ showAlert('Network error','error'); if (window.notify) notify.error('Network error'); }
        submitBtn.disabled=false; submitBtn.textContent='Submit';
      });
    }
  </script>
  <script src="../assets/js/notify.js"></script>
  <script src="../assets/js/auth-guard.js"></script>
  <script src="../assets/js/bottom-nav.js"></script>
  <script src="../assets/js/include-footer.js"></script>
  <script>
    // Fix for logout functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Handle logout button click
        const logoutBtn = document.querySelector('.nav-link[href="#"]');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async function(e) {
                e.preventDefault();
                try {
                    const response = await fetch('../../api/auth/logout.php', {
                        method: 'POST',
                        credentials: 'include'
                    });
                    if (response.ok) {
                        localStorage.removeItem('userEmail');
                        window.location.href = '../auth/login.html';
                    } else {
                        throw new Error('Failed to log out');
                    }
                } catch (error) {
                    console.error('Logout error:', error);
                    alert('Failed to log out. Please try again.');
                }
            });
        }
    });
  </script>
</body>
</html>
