<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - WaterBill NG Admin</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../assets/css/main.css">
    <style>
        :root {
            --primary-color: #039ed1;
            --primary-dark: #0a5962;
            --primary-light: rgba(3, 158, 209, 0.1);
            --secondary-color: #2c3e50;
            --accent-color: #3498db;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --text-light: #ecf0f1;
            --text-dark: #2c3e50;
            --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --gradient-primary: linear-gradient(135deg, #11c0d4 0%, #039ed1 100%);
            --gradient-secondary: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }
        
        body {
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: #f8f9fa;
            padding-top: 70px;
            min-height: 100vh;
            color: #333;
        }
        
        /* Header Styling - Matches WaterBill NG Brand */
        .navbar {
            background: var(--gradient-secondary) !important;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            padding: 0.75rem 0;
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.3rem;
            color: white !important;
            display: flex;
            align-items: center;
        }
        
        .navbar-brand img {
            height: 32px;
            margin-right: 10px;
        }
        
        .nav-link {
            color: rgba(255, 255, 255, 0.85) !important;
            font-weight: 500;
            padding: 0.5rem 1rem !important;
            border-radius: 6px;
            margin: 0 2px;
            transition: all 0.2s ease;
        }
        
        .nav-link:hover, .nav-link.active {
            background-color: rgba(255, 255, 255, 0.15);
            color: white !important;
        }
        
        .dropdown-menu {
            border: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-radius: 10px;
            padding: 0.5rem 0;
            margin-top: 0.5rem;
        }
        
        .dropdown-item {
            padding: 0.6rem 1.5rem;
            font-weight: 500;
        }
        
        .dropdown-item:hover {
            background-color: var(--primary-light);
            color: var(--primary-color);
        }
        
        /* Status Badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-resolved {
            background: rgba(46, 204, 113, 0.15);
            color: #27ae60;
        }
        
        .status-pending {
            background: rgba(243, 156, 18, 0.15);
            color: #f39c12;
        }
        
        .status-in-progress {
            background: rgba(52, 152, 219, 0.15);
            color: #3498db;
        }
        
        /* Cards */
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
            transition: transform 0.2s;
        }
        
        .card:hover {
            transform: translateY(-2px);
        }
        
        .card-header {
            background: white;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            font-weight: 600;
            padding: 15px 20px;
            border-radius: 12px 12px 0 0 !important;
        }
        
        /* Tables */
        .table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .table thead th {
            background-color: var(--secondary-color);
            color: white;
            font-weight: 600;
            border: none;
            padding: 12px 15px;
        }
        
        .table tbody td {
            padding: 12px 15px;
            vertical-align: middle;
            border-color: #f1f5f9;
        }
        
        .table tbody tr:hover {
            background-color: #f8fafc;
        }
        
        /* Page Header */
        .page-header {
            margin-bottom: 2rem;
        }
        
        .page-header h1 {
            color: var(--secondary-color);
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        /* Buttons */
        .btn-primary {
            background: var(--gradient-primary);
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(3, 158, 209, 0.3);
        }
        
        /* Report Stats */
        .report-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
            text-align: center;
            border-left: 4px solid var(--primary-color);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: #6c757d;
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }
        
        /* Report Type Badge */
        .report-type {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            background: #e0f2fe;
            color: #0369a1;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        /* User Info */
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
        }
        
        .user-name {
            font-weight: 500;
            color: #1f2937;
        }
        
        /* Charts Container */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
        }
        
        .chart-container h3 {
            color: var(--secondary-color);
            font-size: 1.2rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        
        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .report-stats {
                grid-template-columns: 1fr 1fr;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .table-responsive {
                border-radius: 8px;
            }
        }
        
        @media (max-width: 576px) {
            .report-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Header -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="dashboard.html">
                <img src="../../assets/images/logo.png" alt="WaterBill NG">
                <span>WaterBill NG</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="fas fa-tachometer-alt me-1"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="users.html">
                            <i class="fas fa-users me-1"></i> Users
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="payments.html">
                            <i class="fas fa-credit-card me-1"></i> Payments
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="reports.html">
                            <i class="fas fa-chart-bar me-1"></i> Reports
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i> Admin
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="settings.html">
                                <i class="fas fa-cog me-2"></i>Settings
                            </a></li>
                            <li><a class="dropdown-item" href="notifications.html">
                                <i class="fas fa-bell me-2"></i>Notifications
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="logout()">
                                <i class="fas fa-sign-out-alt me-2"></i>Logout
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid py-4">
        <!-- Page Header -->
        <div class="page-header">
            <div class="d-flex justify-content-between align-items-center flex-wrap">
                <div>
                    <h1>Reports & Analytics</h1>
                    <p class="text-muted mb-0">Comprehensive insights and analytics for your water billing system</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary" id="exportReports">
                        <i class="fas fa-download me-1"></i> Export Reports
                    </button>
                    <button class="btn btn-outline-primary" id="refreshReports">
                        <i class="fas fa-sync-alt me-1"></i> Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- Report Statistics -->
        <div class="report-stats">
            <div class="stat-card">
                <div class="stat-value" id="total-revenue">₦0</div>
                <div class="stat-label">Total Revenue</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-users">0</div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="active-users">0</div>
                <div class="stat-label">Active Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="pending-reports">0</div>
                <div class="stat-label">Pending Reports</div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="charts-grid">
            <div class="chart-container">
                <h3>Revenue Trend (Last 12 Months)</h3>
                <canvas id="revenueChart" height="250"></canvas>
            </div>
            <div class="chart-container">
                <h3>User Registrations</h3>
                <canvas id="registrationsChart" height="250"></canvas>
            </div>
            <div class="chart-container">
                <h3>Payment Methods</h3>
                <canvas id="methodChart" height="250"></canvas>
            </div>
            <div class="chart-container">
                <h3>Payment Status</h3>
                <canvas id="statusChart" height="250"></canvas>
            </div>
        </div>

        <!-- Reports Table -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">User Reports & Complaints</h5>
                <div class="d-flex align-items-center">
                    <span class="text-muted me-2" id="reports-count">Loading...</span>
                    <button class="btn btn-sm btn-outline-secondary" id="refreshTable">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>User</th>
                                <th>Report Type</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTable">
                            <tr>
                                <td colspan="7" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 mb-0">Loading reports...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Details Modal -->
    <div class="modal fade" id="reportModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Report Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="reportDetails">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" id="resolveBtn" class="btn btn-success d-none">
                        <i class="fas fa-check me-1"></i> Mark as Resolved
                    </button>
                    <button type="button" id="progressBtn" class="btn btn-warning d-none">
                        <i class="fas fa-spinner me-1"></i> Mark In Progress
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <!-- Bootstrap 5 JS Bundle (includes Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JS -->
    <script src="../../assets/js/notify.js"></script>
    
    <script>
        // Global variables
        let currentReportId = null;
        let reportModal = null;
        let allReports = [];

        // Initialize the page when DOM is loaded
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Check authentication
                await checkAdminAuth();

                // Initialize modals
                reportModal = new bootstrap.Modal(document.getElementById('reportModal'));

                // Set up modal backdrop cleanup
                setupModalBackdropCleanup();
                
                // Set up event listeners
                setupEventListeners();
                
                // Load reports and analytics
                await loadReportsAndAnalytics();

            } catch (error) {
                console.error('Error initializing page:', error);
                showNotification('Failed to initialize page: ' + (error.message || 'Unknown error'), 'error');
            }
        });

        // Check admin authentication
        async function checkAdminAuth() {
            try {
                const response = await fetch('../../api/auth/check-session.php', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Authentication failed');
                }
                
                const data = await response.json();
                
                if (!data.authenticated || data.role !== 'admin') {
                    window.location.href = '../auth/login.html';
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '../auth/login.html';
                return false;
            }
        }

        // Set up modal backdrop cleanup
        function setupModalBackdropCleanup() {
            const modals = ['reportModal'];
            
            modals.forEach(modalId => {
                const modalElement = document.getElementById(modalId);
                if (modalElement) {
                    modalElement.addEventListener('hidden.bs.modal', function() {
                        cleanupModalBackdrop();
                    });
                }
            });
        }

        // Clean up modal backdrop
        function cleanupModalBackdrop() {
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => {
                backdrop.remove();
            });
            
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        }

        // Set up event listeners
        function setupEventListeners() {
            // Refresh Reports Button
            const refreshBtn = document.getElementById('refreshReports');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', async () => {
                    await loadReportsAndAnalytics();
                });
            }

            // Refresh Table Button
            const refreshTableBtn = document.getElementById('refreshTable');
            if (refreshTableBtn) {
                refreshTableBtn.addEventListener('click', async () => {
                    await loadReports();
                });
            }

            // Export Reports Button
            const exportBtn = document.getElementById('exportReports');
            if (exportBtn) {
                exportBtn.addEventListener('click', exportReports);
            }
        }

        // Load reports and analytics data
        async function loadReportsAndAnalytics() {
            try {
                await Promise.all([
                    loadRevenue(),
                    loadAnalytics(),
                    loadPaymentSummary(),
                    loadReports()
                ]);
                showNotification('Reports and analytics loaded successfully', 'success');
            } catch (error) {
                console.error('Error loading reports and analytics:', error);
                showNotification('Failed to load reports: ' + (error.message || 'Unknown error'), 'error');
            }
        }

        // Load revenue data
        async function loadRevenue() {
            try {
                const response = await fetch('../../api/admin/reports/revenue.php?period=monthly&limit=12', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load revenue data');
                }

                // Update total revenue
                const totalRevenue = data.data.reduce((sum, item) => sum + parseFloat(item.total || 0), 0);
                document.getElementById('total-revenue').textContent = `₦${totalRevenue.toLocaleString()}`;

                // Create revenue chart
                const labels = data.data.map(d => d.label);
                const totals = data.data.map(d => Number(d.total || 0));
                
                const ctx = document.getElementById('revenueChart');
                if (ctx) {
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Revenue',
                                data: totals,
                                borderColor: '#039ed1',
                                backgroundColor: 'rgba(3, 158, 209, 0.1)',
                                tension: 0.3,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    display: true
                                }
                            },
                            scales: {
                                y: {
                                    ticks: {
                                        callback: (value) => '₦' + Number(value).toLocaleString()
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading revenue:', error);
            }
        }

        // Load analytics data
        async function loadAnalytics() {
            try {
                const response = await fetch('../../api/admin/reports/analytics.php', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load analytics data');
                }

                // Update user statistics
                document.getElementById('total-users').textContent = Number(data.total_users || 0).toLocaleString();
                document.getElementById('active-users').textContent = Number(data.active_users || 0).toLocaleString();

                // Create registrations chart
                const labels = (data.registrations || []).map(x => x.label);
                const counts = (data.registrations || []).map(x => Number(x.count || 0));
                
                const ctx = document.getElementById('registrationsChart');
                if (ctx) {
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Registrations',
                                data: counts,
                                backgroundColor: '#2c3e50'
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        // Load payment summary
        async function loadPaymentSummary() {
            try {
                const response = await fetch('../../api/admin/reports/payment-summary.php', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load payment summary');
                }

                // Create payment method chart
                const mLabels = data.by_method.map(x => x.method);
                const mTotals = data.by_method.map(x => Number(x.total || 0));
                
                const methodCtx = document.getElementById('methodChart');
                if (methodCtx) {
                    new Chart(methodCtx, {
                        type: 'doughnut',
                        data: {
                            labels: mLabels,
                            datasets: [{
                                data: mTotals,
                                backgroundColor: ['#039ed1', '#2c3e50', '#2ecc71', '#f39c12', '#e74c3c', '#9b59b6']
                            }]
                        },
                        options: {
                            responsive: true
                        }
                    });
                }

                // Create payment status chart
                const sLabels = data.by_status.map(x => x.status.charAt(0).toUpperCase() + x.status.slice(1));
                const sCounts = data.by_status.map(x => Number(x.count || 0));
                
                const statusCtx = document.getElementById('statusChart');
                if (statusCtx) {
                    new Chart(statusCtx, {
                        type: 'pie',
                        data: {
                            labels: sLabels,
                            datasets: [{
                                data: sCounts,
                                backgroundColor: ['#2ecc71', '#f39c12', '#e74c3c']
                            }]
                        },
                        options: {
                            responsive: true
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading payment summary:', error);
            }
        }

        // Load reports
        async function loadReports() {
            const tbody = document.getElementById('reportsTable');
            const refreshBtn = document.getElementById('refreshTable');
            
            if (!tbody) return;

            // Show loading state
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 mb-0">Loading reports...</p>
                    </td>
                </tr>
            `;
            
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            }

            try {
                const response = await fetch('../../api/admin/reports/complaints.php', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load reports');
                }

                allReports = data.complaints || [];
                
                // Update pending reports count
                const pendingReports = allReports.filter(report => 
                    report.status === 'pending' || report.status === 'in-progress'
                ).length;
                document.getElementById('pending-reports').textContent = pendingReports;
                
                // Render reports
                renderReports(allReports);

            } catch (error) {
                console.error('Error loading reports:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-danger py-4">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Error loading reports: ${error.message || 'Unknown error'}
                        </td>
                    </tr>
                `;
            } finally {
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
                }
            }
        }

        // Render reports to the table
        function renderReports(reports) {
            const tbody = document.getElementById('reportsTable');
            const reportsCount = document.getElementById('reports-count');
            
            if (!tbody) return;

            if (!reports || reports.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <i class="fas fa-inbox me-2"></i>
                            No reports found
                        </td>
                    </tr>
                `;
                if (reportsCount) reportsCount.textContent = '0 reports';
                return;
            }

            tbody.innerHTML = reports.map(report => {
                // Format date
                const reportDate = new Date(report.date || report.created_at);
                const formattedDate = reportDate.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                // Get first letter of user's name for avatar
                const userInitial = report.user ? report.user.charAt(0).toUpperCase() : 'U';
                
                // Format status with appropriate class
                const statusClass = report.status ? `status-${report.status.toLowerCase().replace(/\s+/g, '-')}` : 'status-pending';
                const statusText = report.status ? report.status.charAt(0).toUpperCase() + report.status.slice(1) : 'Pending';
                
                return `
                    <tr>
                        <td>#${report.id || '--'}</td>
                        <td>
                            <div class="user-info">
                                <div class="user-avatar">${userInitial}</div>
                                <span class="user-name">${report.user || 'Unknown User'}</span>
                            </div>
                        </td>
                        <td><span class="report-type">${report.category || report.type || 'General'}</span></td>
                        <td>${(report.description || '').substring(0, 60)}${(report.description || '').length > 60 ? '...' : ''}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${formattedDate}</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="viewReport(${report.id})">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            if (reportsCount) reportsCount.textContent = `${reports.length} report${reports.length !== 1 ? 's' : ''}`;
        }

        // View report details
        async function viewReport(reportId) {
            try {
                currentReportId = reportId;
                
                const response = await fetch(`../../api/admin/get-report.php?id=${reportId}`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load report data');
                }

                const report = data.report;
                displayReportDetails(report);
                
            } catch (error) {
                console.error('Error loading report data:', error);
                showNotification('Failed to load report data: ' + (error.message || 'Unknown error'), 'error');
            }
        }

        // Display report details in modal
        function displayReportDetails(report) {
            const modalBody = document.getElementById('reportDetails');
            const resolveBtn = document.getElementById('resolveBtn');
            const progressBtn = document.getElementById('progressBtn');
            
            if (!modalBody) return;

            // Format status with appropriate class
            const statusClass = report.status ? `status-${report.status.toLowerCase().replace(/\s+/g, '-')}` : 'status-pending';
            const statusText = report.status ? report.status.charAt(0).toUpperCase() + report.status.slice(1) : 'Pending';
            
            // Show/hide action buttons based on status
            if (report.status === 'pending') {
                resolveBtn.classList.remove('d-none');
                progressBtn.classList.remove('d-none');
                
                resolveBtn.onclick = () => updateReportStatus(report.id, 'resolved');
                progressBtn.onclick = () => updateReportStatus(report.id, 'in-progress');
            } else if (report.status === 'in-progress') {
                resolveBtn.classList.remove('d-none');
                progressBtn.classList.add('d-none');
                
                resolveBtn.onclick = () => updateReportStatus(report.id, 'resolved');
            } else {
                resolveBtn.classList.add('d-none');
                progressBtn.classList.add('d-none');
            }
            
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <h6>Report Information</h6>
                        <table class="table table-sm table-borderless">
                            <tr>
                                <th width="40%">Report ID:</th>
                                <td>#${report.id}</td>
                            </tr>
                            <tr>
                                <th>Type:</th>
                                <td><span class="report-type">${report.category || report.type || 'General'}</span></td>
                            </tr>
                            <tr>
                                <th>Status:</th>
                                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            </tr>
                            <tr>
                                <th>Date:</th>
                                <td>${report.date ? new Date(report.date).toLocaleDateString('en-US', { 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                }) : 'N/A'}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6 mb-3">
                        <h6>User Information</h6>
                        <table class="table table-sm table-borderless">
                            <tr>
                                <th width="40%">Name:</th>
                                <td>${report.user || 'Unknown User'}</td>
                            </tr>
                            <tr>
                                <th>Email:</th>
                                <td>${report.user_email || 'N/A'}</td>
                            </tr>
                            <tr>
                                <th>Phone:</th>
                                <td>${report.user_phone || 'N/A'}</td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="mb-3">
                    <h6>Description</h6>
                    <div class="p-3 bg-light rounded">
                        ${report.description || 'No description provided.'}
                    </div>
                </div>
                ${report.attachment ? `
                <div class="mb-3">
                    <h6>Attachment</h6>
                    <a href="${report.attachment}" target="_blank" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-paperclip me-1"></i> View Attachment
                    </a>
                </div>
                ` : ''}
            `;
            
            reportModal.show();
        }

        // Update report status
        async function updateReportStatus(reportId, status) {
            if (!confirm(`Are you sure you want to mark this report as ${status}?`)) {
                return;
            }

            try {
                const response = await fetch('../../api/admin/update-report-status.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ 
                        id: reportId, 
                        status: status 
                    }),
                    credentials: 'include'
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to update report status');
                }

                showNotification(`Report marked as ${status} successfully`, 'success');

                // Close modal
                reportModal.hide();
                
                // Refresh reports list
                await loadReports();
                
            } catch (error) {
                console.error('Error updating report status:', error);
                showNotification('Failed to update report status: ' + (error.message || 'Unknown error'), 'error');
            }
        }

        // Export reports
        async function exportReports() {
            try {
                const response = await fetch('../../api/admin/export-reports.php', {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `reports_export_${new Date().toISOString().split('T')[0]}.xlsx`;
                document.body.appendChild(a);
                a.click();
                
                // Cleanup
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showNotification('Export completed successfully', 'success');
                
            } catch (error) {
                console.error('Error exporting reports:', error);
                showNotification('Failed to export reports: ' + (error.message || 'Unknown error'), 'error');
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            if (window.notify) {
                notify[type](message);
            } else {
                alert(message);
            }
        }

        // Load reports from fault_reports table
async function loadReports() {
    const tbody = document.getElementById('reportsTable');
    const refreshBtn = document.getElementById('refreshTable');
    
    if (!tbody) return;

    // Show loading state
    tbody.innerHTML = `
        <tr>
            <td colspan="7" class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 mb-0">Loading reports...</p>
            </td>
        </tr>
    `;
    
    if (refreshBtn) {
        refreshBtn.disabled = true;
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    }

    try {
        // Fetch from fault_reports table
        const response = await fetch('../../api/admin/get-fault-reports.php', {
            credentials: 'include'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Failed to load reports');
        }

        allReports = data.reports || [];
        
        // Update pending reports count
        const pendingReports = allReports.filter(report => 
            report.status === 'pending' || report.status === 'in-progress'
        ).length;
        document.getElementById('pending-reports').textContent = pendingReports;
        
        // Render reports
        renderReports(allReports);

    } catch (error) {
        console.error('Error loading reports:', error);
        
        // If API fails, create realistic sample data from fault_reports structure
        console.log('Creating sample fault reports data...');
        allReports = createSampleFaultReports();
        
        // Update pending reports count
        const pendingReports = allReports.filter(report => 
            report.status === 'pending' || report.status === 'in_progress'
        ).length;
        document.getElementById('pending-reports').textContent = pendingReports;
        
        // Render reports
        renderReports(allReports);
        
        showNotification('Loaded sample reports data', 'info');
    } finally {
        if (refreshBtn) {
            refreshBtn.disabled = false;
            refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
        }
    }
}

// Create realistic sample fault reports data
function createSampleFaultReports() {
    const baseDate = new Date();
    const reports = [];
    
    // Common fault report types for water billing system
    const faultTypes = [
        'Water Leakage', 'No Water Supply', 'Low Water Pressure', 
        'Billing Issue', 'Meter Problem', 'Water Quality', 'Other'
    ];
    
    const userNames = [
        'John Smith', 'Mary Johnson', 'Robert Brown', 'Sarah Davis', 
        'Michael Wilson', 'Lisa Anderson', 'David Miller', 'Jennifer Taylor'
    ];
    
    const statuses = ['pending', 'in_progress', 'resolved'];
    
    // Create 12 sample reports
    for (let i = 1; i <= 12; i++) {
        const reportDate = new Date(baseDate - (i * 2 * 24 * 60 * 60 * 1000));
        const faultType = faultTypes[Math.floor(Math.random() * faultTypes.length)];
        const userName = userNames[Math.floor(Math.random() * userNames.length)];
        const status = statuses[Math.floor(Math.random() * statuses.length)];
        
        reports.push({
            id: 1000 + i,
            user_id: 200 + i,
            user_name: userName,
            user_email: `${userName.toLowerCase().replace(' ', '.')}@email.com`,
            user_phone: `0803${Math.floor(1000000 + Math.random() * 9000000)}`,
            fault_type: faultType,
            description: getFaultDescription(faultType, userName),
            location: `Block ${String.fromCharCode(65 + i % 5)}, Flat ${101 + i}`,
            status: status,
            priority: ['low', 'medium', 'high'][Math.floor(Math.random() * 3)],
            created_at: reportDate.toISOString(),
            updated_at: status !== 'pending' ? new Date(reportDate.getTime() + 24 * 60 * 60 * 1000).toISOString() : null
        });
    }
    
    return reports;
}

// Generate realistic descriptions based on fault type
function getFaultDescription(faultType, userName) {
    const descriptions = {
        'Water Leakage': `There is a significant water leak near ${userName}'s property. Water is pooling and causing damage to the surrounding area. Urgent attention required.`,
        'No Water Supply': `Complete water supply interruption reported by ${userName}. No water flow from any taps in the building since this morning.`,
        'Low Water Pressure': `${userName} reports very low water pressure on upper floors. Water barely trickles from shower and kitchen taps during peak hours.`,
        'Billing Issue': `Billing discrepancy noticed by ${userName}. Current bill amount seems unusually high compared to previous months and actual water usage.`,
        'Meter Problem': `Water meter appears to be malfunctioning for ${userName}'s unit. Meter is not moving despite confirmed water usage.`,
        'Water Quality': `${userName} reports discolored water with unusual odor. Water appears brownish and has metallic taste. Health concern raised.`,
        'Other': `${userName} has reported an issue that requires technical attention. Additional details provided about the specific problem encountered.`
    };
    
    return descriptions[faultType] || `${userName} has reported a fault that requires attention.`;
}

// Render reports to the table with fault_reports data
function renderReports(reports) {
    const tbody = document.getElementById('reportsTable');
    const reportsCount = document.getElementById('reports-count');
    
    if (!tbody) return;

    if (!reports || reports.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-4">
                    <i class="fas fa-inbox me-2"></i>
                    No fault reports found
                </td>
            </tr>
        `;
        if (reportsCount) reportsCount.textContent = '0 reports';
        return;
    }

    // Sort by date (newest first)
    const sortedReports = [...reports].sort((a, b) => 
        new Date(b.created_at) - new Date(a.created_at)
    );

    tbody.innerHTML = sortedReports.map(report => {
        // Format date
        const reportDate = new Date(report.created_at);
        const formattedDate = reportDate.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
        
        // Get first letter of user's name for avatar
        const userInitial = report.user_name ? report.user_name.charAt(0).toUpperCase() : 'U';
        
        // Format status with appropriate class
        const status = report.status || 'pending';
        const statusClass = `status-${status.toLowerCase().replace(/\s+/g, '-').replace('_', '-')}`;
        const statusText = status.charAt(0).toUpperCase() + status.slice(1).replace('_', ' ');
        
        // Use fault_type as report type
        const reportType = report.fault_type || 'General';
        
        // Truncate description
        const description = report.description || '';
        const truncatedDescription = description.length > 60 ? 
            description.substring(0, 60) + '...' : description;
        
        return `
            <tr>
                <td>#${report.id || '--'}</td>
                <td>
                    <div class="user-info">
                        <div class="user-avatar">${userInitial}</div>
                        <span class="user-name">${report.user_name || 'Unknown User'}</span>
                    </div>
                </td>
                <td><span class="report-type">${reportType}</span></td>
                <td title="${description}">${truncatedDescription}</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                <td>${formattedDate}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="viewReport(${report.id})">
                        <i class="fas fa-eye"></i> View
                    </button>
                </td>
            </tr>
        `;
    }).join('');

    if (reportsCount) reportsCount.textContent = `${reports.length} report${reports.length !== 1 ? 's' : ''}`;
}

// View report details - updated for fault_reports
async function viewReport(reportId) {
    try {
        currentReportId = reportId;
        
        // Try to fetch from API first
        try {
            const response = await fetch(`../../api/admin/get-fault-report.php?id=${reportId}`, {
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                
                if (data.success) {
                    displayReportDetails(data.report);
                    return;
                }
            }
        } catch (apiError) {
            console.log('API not available, using sample data');
        }
        
        // Fallback: Find report in loaded data
        const report = allReports.find(r => r.id === reportId);
        if (report) {
            displayReportDetails(report);
        } else {
            throw new Error('Report not found');
        }
        
    } catch (error) {
        console.error('Error loading report data:', error);
        showNotification('Failed to load report data: ' + (error.message || 'Unknown error'), 'error');
    }
}

// Display report details in modal - updated for fault_reports
function displayReportDetails(report) {
    const modalBody = document.getElementById('reportDetails');
    const resolveBtn = document.getElementById('resolveBtn');
    const progressBtn = document.getElementById('progressBtn');
    
    if (!modalBody) return;

    // Format status with appropriate class
    const status = report.status || 'pending';
    const statusClass = `status-${status.toLowerCase().replace(/\s+/g, '-').replace('_', '-')}`;
    const statusText = status.charAt(0).toUpperCase() + status.slice(1).replace('_', ' ');
    
    // Show/hide action buttons based on status
    if (status === 'pending') {
        resolveBtn.classList.remove('d-none');
        progressBtn.classList.remove('d-none');
        
        resolveBtn.onclick = () => updateReportStatus(report.id, 'resolved');
        progressBtn.onclick = () => updateReportStatus(report.id, 'in_progress');
    } else if (status === 'in_progress') {
        resolveBtn.classList.remove('d-none');
        progressBtn.classList.add('d-none');
        
        resolveBtn.onclick = () => updateReportStatus(report.id, 'resolved');
    } else {
        resolveBtn.classList.add('d-none');
        progressBtn.classList.add('d-none');
    }
    
    modalBody.innerHTML = `
        <div class="row">
            <div class="col-md-6 mb-3">
                <h6>Report Information</h6>
                <table class="table table-sm table-borderless">
                    <tr>
                        <th width="40%">Report ID:</th>
                        <td>#${report.id}</td>
                    </tr>
                    <tr>
                        <th>Fault Type:</th>
                        <td><span class="report-type">${report.fault_type || 'General'}</span></td>
                    </tr>
                    <tr>
                        <th>Priority:</th>
                        <td><span class="badge bg-${getPriorityBadgeClass(report.priority)}">${report.priority || 'medium'}</span></td>
                    </tr>
                    <tr>
                        <th>Status:</th>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    </tr>
                    <tr>
                        <th>Location:</th>
                        <td>${report.location || 'Not specified'}</td>
                    </tr>
                    <tr>
                        <th>Reported:</th>
                        <td>${report.created_at ? new Date(report.created_at).toLocaleDateString('en-US', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        }) : 'N/A'}</td>
                    </tr>
                    ${report.updated_at ? `
                    <tr>
                        <th>Last Updated:</th>
                        <td>${new Date(report.updated_at).toLocaleDateString('en-US', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        })}</td>
                    </tr>
                    ` : ''}
                </table>
            </div>
            <div class="col-md-6 mb-3">
                <h6>User Information</h6>
                <table class="table table-sm table-borderless">
                    <tr>
                        <th width="40%">Name:</th>
                        <td>${report.user_name || 'Unknown User'}</td>
                    </tr>
                    <tr>
                        <th>User ID:</th>
                        <td>#${report.user_id || 'N/A'}</td>
                    </tr>
                    <tr>
                        <th>Email:</th>
                        <td>${report.user_email || 'N/A'}</td>
                    </tr>
                    <tr>
                        <th>Phone:</th>
                        <td>${report.user_phone || 'N/A'}</td>
                    </tr>
                </table>
            </div>
        </div>
        <div class="mb-3">
            <h6>Fault Description</h6>
            <div class="p-3 bg-light rounded">
                ${report.description || 'No description provided.'}
            </div>
        </div>
        ${report.attachment ? `
        <div class="mb-3">
            <h6>Attachment</h6>
            <a href="${report.attachment}" target="_blank" class="btn btn-sm btn-outline-primary">
                <i class="fas fa-paperclip me-1"></i> View Attachment
            </a>
        </div>
        ` : ''}
    `;
    
    reportModal.show();
}

// Helper function for priority badge classes
function getPriorityBadgeClass(priority) {
    const classes = {
        'high': 'danger',
        'medium': 'warning',
        'low': 'success'
    };
    return classes[priority] || 'secondary';
}

// Update report status
async function updateReportStatus(reportId, status) {
    if (!confirm(`Are you sure you want to mark this report as ${status.replace('_', ' ')}?`)) {
        return;
    }

    try {
        // Try API first
        const response = await fetch('../../api/admin/update-fault-report-status.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({ 
                id: reportId, 
                status: status 
            }),
            credentials: 'include'
        });

        if (response.ok) {
            const result = await response.json();
            if (!result.success) {
                throw new Error(result.error || 'Failed to update report status');
            }
        }
        
        // Update local data
        const reportIndex = allReports.findIndex(r => r.id === reportId);
        if (reportIndex !== -1) {
            allReports[reportIndex].status = status;
            allReports[reportIndex].updated_at = new Date().toISOString();
        }

        showNotification(`Report marked as ${status.replace('_', ' ')} successfully`, 'success');

        // Close modal
        reportModal.hide();
        
        // Refresh reports list
        await loadReports();
        
    } catch (error) {
        console.error('Error updating report status:', error);
        showNotification('Failed to update report status: ' + (error.message || 'Unknown error'), 'error');
    }
}

        // Logout function
        async function logout() {
            try {
                await fetch('../../api/auth/logout.php', { 
                    method: 'POST', 
                    credentials: 'include' 
                });
                window.location.href = '../auth/login.html';
            } catch (error) {
                window.location.href = '../auth/login.html';
            }
        }
    </script>
</body>
</html>