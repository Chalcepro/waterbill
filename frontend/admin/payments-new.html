<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payments - WaterBill NG Admin</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../assets/css/main.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --text-light: #ecf0f1;
            --text-dark: #2c3e50;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: #f8f9fa;
            padding-top: 70px;
            min-height: 100vh;
            color: #333;
            font-size: 1rem;
            line-height: 1.5;
        }
        
        /* Responsive adjustments */
        .container-fluid {
            padding-right: 1.5rem;
            padding-left: 1.5rem;
        }

        /* Table styling */
        .table {
            font-size: 0.95rem;
        }

        .table th {
            font-weight: 600;
            white-space: nowrap;
        }

        .table td {
            vertical-align: middle;
        }

        /* Card styling */
        .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            margin-bottom: 1.5rem;
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Form controls */
        .form-control, .form-select {
            padding: 0.5rem 0.75rem;
            height: auto;
            font-size: 0.95rem;
        }

        /* Responsive adjustments */
        @media (max-width: 991.98px) {
            .container-fluid {
                padding-right: 1rem;
                padding-left: 1rem;
            }

            .card-body {
                padding: 1.25rem;
            }

            .table {
                font-size: 0.9rem;
            }

            .btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.9rem;
            }

            .table-responsive {
                border: none;
                margin: 0 -1rem;
                width: calc(100% + 2rem);
            }

            .table td, .table th {
                padding: 0.75rem 1rem;
            }
        }

        /* Extra small devices */
        @media (max-width: 575.98px) {
            .container-fluid {
                padding-right: 0.75rem;
                padding-left: 0.75rem;
            }

            .card-body {
                padding: 1rem;
            }

            .table {
                font-size: 0.85rem;
            }

            .btn {
                padding: 0.35rem 0.7rem;
                font-size: 0.85rem;
            }

            .table td, .table th {
                padding: 0.5rem 0.75rem;
            }

            /* Stack buttons on mobile */
            .btn-group .btn {
                margin-bottom: 0.25rem;
            }

            .btn-group {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <!-- Responsive Admin Header -->
    <div id="admin-header">
        <!-- Header will be loaded here -->
    </div>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">Payment Management</h1>
            <div>
                <button class="btn btn-primary" onclick="loadPayments()">
                    <i class="fas fa-sync-alt me-1"></i> Refresh
                </button>
                <button class="btn btn-success ms-2" data-bs-toggle="modal" data-bs-target="#exportModal">
                    <i class="fas fa-file-export me-1"></i> Export
                </button>
            </div>
        </div>

        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="statusFilter">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="declined">Declined</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Payment Method</label>
                        <select class="form-select" id="methodFilter">
                            <option value="">All Methods</option>
                            <option value="card">Card</option>
                            <option value="bank_transfer">Bank Transfer</option>
                            <option value="manual">Manual</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">From Date</label>
                        <input type="date" class="form-control" id="dateFrom">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">To Date</label>
                        <div class="input-group">
                            <input type="date" class="form-control" id="dateTo">
                            <button class="btn btn-outline-secondary" type="button" onclick="filterPayments()">
                                <i class="fas fa-filter"></i> Filter
                            </button>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-link text-muted p-0" onclick="resetFilters()">
                        <i class="fas fa-times me-1"></i> Clear filters
                    </button>
                </div>
            </div>
        </div>

        <!-- Payments Table -->
        <div class="card">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>User</th>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsTableBody">
                            <!-- Payments will be loaded here -->
                            <tr>
                                <td colspan="7" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 mb-0">Loading payments...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Details Modal -->
    <div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paymentModalTitle">Payment Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="paymentModalBody">
                    <!-- Payment details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" id="approveBtn" onclick="updatePaymentStatus(currentPaymentId, 'approved')">
                        <i class="fas fa-check me-1"></i> Approve
                    </button>
                    <button type="button" class="btn btn-danger" id="rejectBtn" onclick="updatePaymentStatus(currentPaymentId, 'declined')">
                        <i class="fas fa-times me-1"></i> Reject
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal fade" id="exportModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Export Payments</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Export Format</label>
                        <select class="form-select" id="exportFormat">
                            <option value="csv">CSV</option>
                            <option value="excel">Excel</option>
                            <option value="pdf">PDF</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Date Range</label>
                        <div class="input-group mb-2">
                            <span class="input-group-text">From</span>
                            <input type="date" class="form-control" id="exportDateFrom">
                        </div>
                        <div class="input-group">
                            <span class="input-group-text">To</span>
                            <input type="date" class="form-control" id="exportDateTo">
                        </div>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="includeAllFields" checked>
                        <label class="form-check-label" for="includeAllFields">
                            Include all fields
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="exportPayments()">
                        <i class="fas fa-download me-1"></i> Export
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Required Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Global variables
        let currentPaymentId = null;
        let paymentModal = null;
        let exportModal = null;

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize modals
            paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
            exportModal = new bootstrap.Modal(document.getElementById('exportModal'));
            
            // Load responsive admin header
            fetch('/waterbill/frontend/includes/admin-header-responsive.html')
                .then(response => response.text())
                .then(html => {
                    const header = document.getElementById('admin-header');
                    if (header) {
                        header.innerHTML = html;
                        
                        // Highlight current menu item
                        const currentPage = window.location.pathname.split('/').pop() || 'dashboard.html';
                        document.querySelectorAll('.nav-link').forEach(link => {
                            const href = link.getAttribute('href');
                            if (href === currentPage || 
                                (currentPage.includes(href.replace('.html', '')) && href !== '#')) {
                                link.classList.add('active');
                            }
                        });
                    }
                })
                .catch(error => console.error('Error loading header:', error));
            
            // Load initial data
            loadPayments();
            
            // Setup event listeners
            setupEventListeners();
        });

        // Setup event listeners
        function setupEventListeners() {
            // Filter form submission
            document.getElementById('filterForm')?.addEventListener('submit', function(e) {
                e.preventDefault();
                filterPayments();
            });
            
            // Reset filters button
            document.getElementById('resetFilters')?.addEventListener('click', function() {
                resetFilters();
            });
            
            // Export button
            document.getElementById('exportBtn')?.addEventListener('click', function() {
                exportModal.show();
            });
        }
        
        // Load payments from the database
        async function loadPayments(filters = {}) {
            try {
                // Show loading state
                const tbody = document.getElementById('paymentsTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 mb-0">Loading payments...</p>
                        </td>
                    </tr>`;
                
                // In a real app, you would fetch this from your API
                // const response = await fetch('/api/payments?' + new URLSearchParams(filters));
                // const data = await response.json();
                
                // Mock data for demonstration
                setTimeout(() => {
                    const mockData = [
                        {
                            id: 'PAY-001',
                            user: 'John Doe',
                            amount: '₦15,000.00',
                            method: 'Card',
                            status: 'approved',
                            date: '2023-06-15 14:30:22',
                            receipt: 'receipt_12345.jpg'
                        },
                        // Add more mock data as needed
                    ];
                    
                    renderPayments(mockData);
                }, 500);
                
            } catch (error) {
                console.error('Error loading payments:', error);
                showError('Failed to load payments. Please try again.');
            }
        }
        
        // Render payments in the table
        function renderPayments(payments) {
            const tbody = document.getElementById('paymentsTableBody');
            
            if (!payments || payments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                            <p class="mb-0">No payments found</p>
                        </td>
                    </tr>`;
                return;
            }
            
            tbody.innerHTML = payments.map(payment => `
                <tr>
                    <td>${payment.id}</td>
                    <td>${payment.user}</td>
                    <td>${payment.amount}</td>
                    <td>${payment.method}</td>
                    <td><span class="badge bg-${getStatusBadgeClass(payment.status)}">${formatStatus(payment.status)}</span></td>
                    <td>${new Date(payment.date).toLocaleString()}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewPayment('${payment.id}')">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        // Get badge class based on status
        function getStatusBadgeClass(status) {
            switch (status.toLowerCase()) {
                case 'approved': return 'success';
                case 'pending': return 'warning';
                case 'declined': return 'danger';
                default: return 'secondary';
            }
        }
        
        // Format status text
        function formatStatus(status) {
            return status.charAt(0).toUpperCase() + status.slice(1);
        }
        
        // Reset all filters
        function resetFilters() {
            document.getElementById('statusFilter').value = '';
            document.getElementById('methodFilter').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            loadPayments();
        }
        
        // Apply filters
        function filterPayments() {
            const status = document.getElementById('statusFilter').value;
            const method = document.getElementById('methodFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            loadPayments({ status, method, dateFrom, dateTo });
        }
        
        // View payment details
        function viewPayment(paymentId) {
            currentPaymentId = paymentId;
            
            // In a real app, you would fetch payment details from your API
            // fetch(`/api/payments/${paymentId}`)
            //     .then(response => response.json())
            //     .then(payment => {
            //         displayPaymentDetails(payment);
            //         paymentModal.show();
            //     });
            
            // Mock data for demonstration
            const mockPayment = {
                id: paymentId,
                user: 'John Doe',
                email: 'john.doe@example.com',
                amount: '₦15,000.00',
                method: 'Card',
                status: 'pending',
                date: '2023-06-15 14:30:22',
                reference: 'PAY-REF-12345',
                receipt: 'receipt_12345.jpg',
                notes: 'Payment for monthly water bill'
            };
            
            displayPaymentDetails(mockPayment);
            paymentModal.show();
        }
        
        // Display payment details in modal
        function displayPaymentDetails(payment) {
            document.getElementById('paymentModalTitle').textContent = `Payment #${payment.id}`;
            
            const modalBody = document.getElementById('paymentModalBody');
            modalBody.innerHTML = `
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p class="mb-1 text-muted">User</p>
                        <p class="mb-3">${payment.user} <small class="text-muted">(${payment.email})</small></p>
                        
                        <p class="mb-1 text-muted">Payment Method</p>
                        <p class="mb-3">${payment.method}</p>
                        
                        <p class="mb-1 text-muted">Amount</p>
                        <h4 class="mb-3">${payment.amount}</h4>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1 text-muted">Status</p>
                        <p class="mb-3"><span class="badge bg-${getStatusBadgeClass(payment.status)}">${formatStatus(payment.status)}</span></p>
                        
                        <p class="mb-1 text-muted">Date</p>
                        <p class="mb-3">${new Date(payment.date).toLocaleString()}</p>
                        
                        <p class="mb-1 text-muted">Reference</p>
                        <p class="mb-3">${payment.reference || 'N/A'}</p>
                    </div>
                </div>
                
                ${payment.notes ? `
                <div class="mb-3">
                    <p class="mb-1 text-muted">Notes</p>
                    <p>${payment.notes}</p>
                </div>` : ''}
                
                ${payment.receipt ? `
                <div class="mb-3">
                    <p class="mb-2 text-muted">Receipt</p>
                    <img src="../uploads/receipts/${payment.receipt}" alt="Payment Receipt" class="img-fluid rounded border" style="max-height: 300px;">
                </div>` : ''}
            `;
            
            // Update action buttons based on status
            const approveBtn = document.getElementById('approveBtn');
            const rejectBtn = document.getElementById('rejectBtn');
            
            if (payment.status === 'approved') {
                approveBtn.disabled = true;
                rejectBtn.disabled = false;
            } else if (payment.status === 'declined') {
                approveBtn.disabled = false;
                rejectBtn.disabled = true;
            } else {
                approveBtn.disabled = false;
                rejectBtn.disabled = false;
            }
        }
        
        // Update payment status
        function updatePaymentStatus(paymentId, status) {
            if (!confirm(`Are you sure you want to ${status} this payment?`)) {
                return;
            }
            
            // In a real app, you would make an API call to update the status
            // fetch(`/api/payments/${paymentId}/status`, {
            //     method: 'PUT',
            //     headers: { 'Content-Type': 'application/json' },
            //     body: JSON.stringify({ status })
            // })
            // .then(response => response.json())
            // .then(data => {
            //     showSuccess(`Payment ${status} successfully`);
            //     paymentModal.hide();
            //     loadPayments();
            // });
            
            // For demo purposes
            setTimeout(() => {
                showSuccess(`Payment ${status} successfully`);
                paymentModal.hide();
                loadPayments();
            }, 500);
        }
        
        // Export payments
        function exportPayments() {
            const format = document.getElementById('exportFormat').value;
            const dateFrom = document.getElementById('exportDateFrom').value;
            const dateTo = document.getElementById('exportDateTo').value;
            const includeAllFields = document.getElementById('includeAllFields').checked;
            
            // In a real app, you would make an API call to export the data
            // const params = new URLSearchParams({
            //     format,
            //     dateFrom: dateFrom || undefined,
            //     dateTo: dateTo || undefined,
            //     includeAllFields
            // });
            // 
            // window.location.href = `/api/payments/export?${params}`;
            
            // For demo purposes
            showSuccess(`Exporting payments as ${format.toUpperCase()}...`);
            exportModal.hide();
        }
        
        // Show success message
        function showSuccess(message) {
            alert('Success: ' + message);
        }
        
        // Show error message
        function showError(message) {
            alert('Error: ' + message);
        }
    </script>
</body>
</html>
